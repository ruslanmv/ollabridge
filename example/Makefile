.PHONY: help install run test clean check-ollama check-ollabridge check-setup start debug

# Default target
help:
	@echo ""
	@echo "â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®"
	@echo "â”‚                                                    â”‚"
	@echo "â”‚  ðŸŽ¯ OllaBridge Demo Client - Super Easy! ðŸŽ¯       â”‚"
	@echo "â”‚                                                    â”‚"
	@echo "â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯"
	@echo ""
	@echo "ðŸš€ SUPER QUICK START (RECOMMENDED):"
	@echo ""
	@echo "  â­ make start       ðŸ‘ˆ Start ALL services automatically!"
	@echo "  â­ make run         ðŸ‘ˆ Open the demo"
	@echo ""
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo ""
	@echo "ðŸ› ï¸  Manual Setup (if needed):"
	@echo ""
	@echo "  1ï¸âƒ£  make install    ðŸ‘ˆ Install OllaBridge"
	@echo "  2ï¸âƒ£  make run        ðŸ‘ˆ Start the demo"
	@echo ""
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo ""
	@echo "ðŸ’¡ Other helpful commands:"
	@echo ""
	@echo "  make debug            - Debug connection issues ðŸ”"
	@echo "  make check-setup      - Check if everything is configured"
	@echo "  make test             - Run connection tests"
	@echo "  make check-ollama     - Is Ollama running?"
	@echo "  make check-ollabridge - Is OllaBridge running?"
	@echo "  make clean            - Stop all servers"
	@echo ""
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo ""
	@echo "â“ FIRST TIME USER?"
	@echo ""
	@echo "  Just type:  make start    (starts everything!)"
	@echo "  Then type:  make run      (opens the demo)"
	@echo ""
	@echo "  Having issues? Run: make debug ðŸ”"
	@echo ""
	@echo "  That's it! Follow the instructions on screen ðŸŽ‰"
	@echo ""

# Install OllaBridge
install:
	@echo "ðŸ“¦ Installing OllaBridge..."
	@if python3 -c "import ollabridge" 2>/dev/null; then \
		echo "âœ“ OllaBridge is already installed"; \
		python3 -c "import ollabridge; print(f'Version: {ollabridge.__version__ if hasattr(ollabridge, \"__version__\") else \"installed\"}')" 2>/dev/null || echo "Version: installed"; \
	else \
		echo "Installing OllaBridge via pip..."; \
		python3 -m pip install --upgrade pip; \
		python3 -m pip install ollabridge; \
		echo "âœ“ OllaBridge installed successfully"; \
	fi
	@echo ""
	@echo "Next steps:"
	@echo "  1. Ensure Ollama is running (ollama serve)"
	@echo "  2. Pull a model (ollama pull deepseek-r1)"
	@echo "  3. Start OllaBridge (ollabridge start)"
	@echo "  4. Run: make run"
	@echo ""

# Run the demo client web server
run:
	@echo ""
	@echo "â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®"
	@echo "â”‚                                                       â”‚"
	@echo "â”‚  ðŸš€ OllaBridge Demo Client Starting...               â”‚"
	@echo "â”‚                                                       â”‚"
	@echo "â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯"
	@echo ""
	@echo "ðŸ” Pre-flight checks..."
	@echo ""
	@# Check if OllaBridge is running
	@if ! curl -s --connect-timeout 2 http://localhost:11435/health > /dev/null 2>&1; then \
		echo "âŒ ERROR: OllaBridge is NOT running!"; \
		echo ""; \
		echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"; \
		echo ""; \
		echo "ðŸš€ QUICK FIX:"; \
		echo ""; \
		echo "   Option 1 (Recommended - Automatic):"; \
		echo "   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"; \
		echo "   make start    ðŸ‘ˆ Starts Ollama + OllaBridge automatically"; \
		echo "   make run      ðŸ‘ˆ Then run this command again"; \
		echo ""; \
		echo "   Option 2 (Manual):"; \
		echo "   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"; \
		echo "   Terminal 1: ollama serve"; \
		echo "   Terminal 2: ollabridge start"; \
		echo "   Terminal 3: make run"; \
		echo ""; \
		echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"; \
		echo ""; \
		echo "ðŸ’¡ Need help? Run: make debug"; \
		echo ""; \
		exit 1; \
	fi
	@# Check if Ollama is running
	@if ! curl -s --connect-timeout 2 http://localhost:11434/api/tags > /dev/null 2>&1; then \
		echo "âš ï¸  WARNING: Ollama may not be running"; \
		echo "   OllaBridge needs Ollama to function properly"; \
		echo ""; \
		echo "   Quick fix: make start"; \
		echo ""; \
	fi
	@echo "âœ… OllaBridge is running!"
	@echo ""
	@echo "ðŸ“‹ Auto-configuring connection settings..."
	@echo ""
	@if [ -f ../.env ]; then \
		API_KEY=$$(grep "^API_KEYS=" ../.env | cut -d'=' -f2 | cut -d',' -f1 | tr -d ' "' || echo "dev-key-change-me"); \
	else \
		API_KEY="dev-key-change-me"; \
	fi; \
	echo "// Auto-generated config - DO NOT EDIT" > config.js; \
	echo "window.OLLABRIDGE_CONFIG = {" >> config.js; \
	echo "  serverUrl: 'http://localhost:11435'," >> config.js; \
	echo "  apiKey: '$$API_KEY'" >> config.js; \
	echo "};" >> config.js; \
	echo "âœ“ Configuration ready"
	@echo ""
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo ""
	@echo "ðŸ“‹ Connection Details (auto-filled in browser)"
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo ""
	@echo "  Server URL:  http://localhost:11435"
	@echo ""
	@if [ -f ../.env ]; then \
		API_KEY=$$(grep "^API_KEYS=" ../.env | cut -d'=' -f2 | cut -d',' -f1 | tr -d ' "' || echo "dev-key-change-me"); \
		echo "  API Key:     $$API_KEY"; \
	else \
		echo "  API Key:     dev-key-change-me"; \
	fi
	@echo ""
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo ""
	@echo "ðŸŽ¯ SUPER EASY MODE ACTIVATED!"
	@echo ""
	@echo "  ðŸ‘‰ Open: http://localhost:3000"
	@echo ""
	@echo "  âœ¨ Values are auto-filled - just click 'Connect'!"
	@echo ""
	@echo "  âš ï¸  Use http://localhost:3000 (NOT 127.0.0.1:3000)"
	@echo ""
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo ""
	@echo "âš¡ Press Ctrl+C to stop the server"
	@echo ""
	@cd $$(pwd) && python3 -m http.server 3000 --bind 127.0.0.1

# Run comprehensive tests
test: check-ollama check-ollabridge
	@echo ""
	@echo "================================================"
	@echo "  Running Demo Client Tests"
	@echo "================================================"
	@echo ""
	@echo "Testing OllaBridge endpoints..."
	@echo ""
	@echo "1. Health Check:"
	@curl -s http://localhost:11435/health | python3 -m json.tool || echo "âŒ Health check failed"
	@echo ""
	@echo "2. Models List (requires API key):"
	@curl -s -H "Authorization: Bearer dev-key-change-me" http://localhost:11435/v1/models | python3 -m json.tool || echo "âŒ Models check failed"
	@echo ""
	@echo "âœ… All tests completed!"
	@echo ""
	@echo "You can now run 'make run' to start the demo client"
	@echo ""

# Check if Ollama is running
check-ollama:
	@echo "Checking Ollama..."
	@if curl -s http://localhost:11434/api/tags > /dev/null 2>&1; then \
		echo "âœ“ Ollama is running"; \
	else \
		echo "âŒ Ollama is not running"; \
		echo "   Start it with: ollama serve"; \
		exit 1; \
	fi

# Check if OllaBridge is running
check-ollabridge:
	@echo "Checking OllaBridge..."
	@if curl -s http://localhost:11435/health > /dev/null 2>&1; then \
		echo "âœ“ OllaBridge is running"; \
	else \
		echo "âŒ OllaBridge is not running"; \
		echo "   Start it with: ollabridge start"; \
		exit 1; \
	fi

# Check complete setup
check-setup:
	@./check-setup.sh

# Start all services (Ollama + OllaBridge)
start:
	@./start-services.sh

# Debug connection issues
debug:
	@./debug-connection.sh

# Clean up
clean:
	@echo "ðŸ§¹ Cleaning up..."
	@pkill -f "http.server 3000" 2>/dev/null || echo "No web server to stop"
	@rm -f config.js 2>/dev/null || true
	@echo "âœ“ Cleanup complete"
	@echo ""
