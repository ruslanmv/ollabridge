<!DOCTYPE html>
<html lang="en">
<head>
  <base target="_self">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OllaBridge Connect</title>
  <meta name="description" content="Connect to your local OllaBridge instance in just 2 clicks" />

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: { light: '#818cf8', DEFAULT: '#6366f1', dark: '#4f46e5' },
            secondary: { light: '#a5b4fc', DEFAULT: '#7c3aed', dark: '#5b21b6' }
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', '-apple-system', 'Segoe UI', 'Roboto', 'sans-serif']
          }
        }
      }
    };
  </script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
    .gradient-text {
      background: linear-gradient(90deg, #6366f1, #8b5cf6);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }
    .card-gradient {
      background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(243,244,246,0.9) 100%);
    }
    .console {
      font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
      font-size: 0.875rem;
    }
  </style>
</head>

<body class="min-h-screen bg-gray-50 font-sans">
  <div class="container mx-auto px-4 py-8 max-w-4xl">
    <!-- Hero -->
    <header class="text-center mb-12">
      <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mb-4">
        OllaBridge <span class="gradient-text">Connect</span>
      </h1>
      <p class="text-lg md:text-xl text-gray-600 mb-6">
        One endpoint. Any compute. Works with agents via MCP.
      </p>
      <div class="flex justify-center">
        <span class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium bg-indigo-100 text-indigo-800">
          <svg class="mr-1.5 h-2 w-2 text-indigo-400" fill="currentColor" viewBox="0 0 8 8">
            <circle cx="4" cy="4" r="3" />
          </svg>
          Compatible with OllaBridge
        </span>
      </div>
    </header>

    <!-- Steps -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-12">
      <!-- Step 1 -->
      <div class="card-gradient rounded-xl p-6 shadow-sm border border-gray-200">
        <div class="flex items-center mb-4">
          <div class="flex items-center justify-center w-10 h-10 rounded-full bg-indigo-100 text-indigo-600 font-bold mr-4">1</div>
          <h3 class="text-xl font-semibold text-gray-800">Install OllaBridge</h3>
        </div>
        <p class="text-gray-600 mb-6">
          Install OllaBridge on your local machine (and run it). This demo button just shows commands.
        </p>
        <button id="installBtn"
          class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-lg transition">
          <i class="fas fa-download mr-2"></i> Show Install Commands
        </button>
      </div>

      <!-- Step 2 -->
      <div class="card-gradient rounded-xl p-6 shadow-sm border border-gray-200">
        <div class="flex items-center mb-4">
          <div class="flex items-center justify-center w-10 h-10 rounded-full bg-indigo-100 text-indigo-600 font-bold mr-4">2</div>
          <h3 class="text-xl font-semibold text-gray-800">Connect to Server</h3>
        </div>

        <div class="mb-4">
          <label for="serverUrl" class="block text-sm font-medium text-gray-700 mb-1">Server URL</label>
          <div class="relative rounded-md shadow-sm">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <i class="fas fa-server text-gray-400"></i>
            </div>
            <input type="text" id="serverUrl"
              class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"
              placeholder="http://localhost:11435"
              value="http://localhost:11435">
          </div>
          <p class="text-xs text-gray-500 mt-1">Tip: OllaBridge OpenAI base URL is <code>/v1</code></p>
        </div>

        <div class="mb-4">
          <label for="apiKey" class="block text-sm font-medium text-gray-700 mb-1">API Key</label>
          <div class="relative rounded-md shadow-sm">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <i class="fas fa-key text-gray-400"></i>
            </div>
            <input type="password" id="apiKey"
              class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"
              placeholder="dev-key-change-me">
          </div>
          <p class="text-xs text-gray-500 mt-1">Matches <code>API_KEYS</code> in OllaBridge <code>.env</code></p>
        </div>

        <button id="connectBtn"
          class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-lg transition">
          <i class="fas fa-plug mr-2"></i> Connect
        </button>
      </div>
    </div>

    <!-- Status -->
    <div class="flex justify-between items-center mb-6">
      <div>
        <span id="statusPill"
          class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800">
          <svg class="mr-1.5 h-2 w-2 text-red-400" fill="currentColor" viewBox="0 0 8 8">
            <circle cx="4" cy="4" r="3" />
          </svg>
          Offline
        </span>
      </div>
      <button id="disconnectBtn" class="hidden text-sm font-medium text-indigo-600 hover:text-indigo-500">
        <i class="fas fa-power-off mr-1"></i> Disconnect
      </button>
    </div>

    <!-- Stats -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
      <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-200">
        <p class="text-sm text-gray-500">Requests Sent</p>
        <p id="requestsSent" class="text-2xl font-semibold text-gray-900">0</p>
      </div>
      <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-200">
        <p class="text-sm text-gray-500">Avg Latency</p>
        <p id="avgLatency" class="text-2xl font-semibold text-gray-900">0 ms</p>
      </div>
      <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-200">
        <p class="text-sm text-gray-500">Last Response</p>
        <p id="lastResponseTime" class="text-2xl font-semibold text-gray-900">0 ms</p>
      </div>
      <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-200">
        <p class="text-sm text-gray-500">Uptime</p>
        <p id="uptime" class="text-2xl font-semibold text-gray-900">00:00:00</p>
      </div>
    </div>

    <!-- Log -->
    <div class="mb-8">
      <div class="flex justify-between items-center mb-2">
        <h3 class="text-lg font-medium text-gray-900">Connection Log</h3>
        <button id="clearLogBtn" class="text-sm text-indigo-600 hover:text-indigo-500">
          <i class="fas fa-trash-alt mr-1"></i> Clear
        </button>
      </div>
      <div id="consoleLog" class="console bg-gray-900 text-gray-200 p-4 rounded-lg h-52 overflow-y-auto mb-4">
        <div class="text-green-400">> Ready to connect to OllaBridge...</div>
      </div>
    </div>

    <!-- Models + Prompt -->
    <div class="mb-12">
      <div class="flex items-center justify-between mb-2">
        <h3 class="text-lg font-medium text-gray-900">Test Prompt</h3>
        <div class="w-56">
          <select id="modelSelect"
            class="block w-full border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 p-2 text-sm">
            <option value="">(load models after connect)</option>
          </select>
        </div>
      </div>

      <div class="mb-4">
        <textarea id="testPrompt" rows="3"
          class="block w-full border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 p-3"
          placeholder="Enter your test prompt here..."></textarea>
      </div>

      <div class="flex justify-between items-center">
        <div id="errorCount" class="text-sm text-red-600 hidden">
          <i class="fas fa-exclamation-circle mr-1"></i>
          <span id="errorCountText">0 errors</span>
        </div>
        <button id="sendPromptBtn"
          class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700">
          <i class="fas fa-paper-plane mr-2"></i> Send Prompt
        </button>
      </div>

      <!-- Response -->
      <div id="responseOutput" class="mt-4 hidden">
        <h4 class="text-md font-medium text-gray-900 mb-2">Response</h4>
        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
          <pre id="responseContent" class="text-sm text-gray-800 whitespace-pre-wrap"></pre>
        </div>
      </div>
    </div>

    <footer class="border-t border-gray-200 pt-8">
      <div class="text-center">
        <p class="text-sm text-gray-500 mb-4">
          <a href="https://github.com/ruslanmv/ollabridge" class="text-indigo-600 hover:text-indigo-500 font-medium">
            <i class="fab fa-github mr-1"></i> Star us on GitHub
          </a>
        </p>
        <p class="text-xs text-gray-400">Built with OllaBridge - OpenAI-compatible gateway for Ollama</p>
      </div>
    </footer>
  </div>

  <script>
    // DOM
    const installBtn = document.getElementById('installBtn');
    const connectBtn = document.getElementById('connectBtn');
    const disconnectBtn = document.getElementById('disconnectBtn');
    const serverUrlInput = document.getElementById('serverUrl');
    const apiKeyInput = document.getElementById('apiKey');
    const modelSelect = document.getElementById('modelSelect');

    const statusPill = document.getElementById('statusPill');
    const consoleLog = document.getElementById('consoleLog');
    const clearLogBtn = document.getElementById('clearLogBtn');

    const testPrompt = document.getElementById('testPrompt');
    const sendPromptBtn = document.getElementById('sendPromptBtn');

    const responseOutput = document.getElementById('responseOutput');
    const responseContent = document.getElementById('responseContent');

    const errorCount = document.getElementById('errorCount');
    const errorCountText = document.getElementById('errorCountText');

    const requestsSent = document.getElementById('requestsSent');
    const avgLatency = document.getElementById('avgLatency');
    const lastResponseTime = document.getElementById('lastResponseTime');
    const uptime = document.getElementById('uptime');

    // State
    let isConnected = false;
    let startTime = null;
    let uptimeTimer = null;

    let requestCount = 0;
    let totalLatency = 0;
    let errorCountValue = 0;

    let serverBase = "";  // like http://localhost:11435
    let apiKey = "";

    // Helpers
    function addToConsole(message, color = 'white') {
      const colors = {
        red: 'text-red-400',
        green: 'text-green-400',
        blue: 'text-blue-400',
        yellow: 'text-yellow-400',
        white: 'text-gray-200'
      };
      const div = document.createElement('div');
      div.className = colors[color] || 'text-gray-200';
      div.textContent = message;
      consoleLog.appendChild(div);
      consoleLog.scrollTop = consoleLog.scrollHeight;
    }

    function setErrorCount() {
      if (errorCountValue > 0) {
        errorCount.classList.remove('hidden');
        errorCountText.textContent = `${errorCountValue} error${errorCountValue === 1 ? '' : 's'}`;
      } else {
        errorCount.classList.add('hidden');
      }
    }

    function updateConnectionStatus(connected) {
      isConnected = connected;

      if (connected) {
        statusPill.className =
          'inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800';
        statusPill.innerHTML = `
          <svg class="mr-1.5 h-2 w-2 text-green-400" fill="currentColor" viewBox="0 0 8 8">
            <circle cx="4" cy="4" r="3" />
          </svg>
          Connected
        `;
        connectBtn.classList.add('hidden');
        disconnectBtn.classList.remove('hidden');
      } else {
        statusPill.className =
          'inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800';
        statusPill.innerHTML = `
          <svg class="mr-1.5 h-2 w-2 text-red-400" fill="currentColor" viewBox="0 0 8 8">
            <circle cx="4" cy="4" r="3" />
          </svg>
          Offline
        `;
        connectBtn.classList.remove('hidden');
        disconnectBtn.classList.add('hidden');
      }
    }

    function showResponse(content) {
      responseContent.textContent = content;
      responseOutput.classList.remove('hidden');
    }

    function updateUptime() {
      if (!startTime) return;
      const diff = Date.now() - startTime.getTime();
      const hours = Math.floor(diff / 3600000).toString().padStart(2, '0');
      const minutes = Math.floor((diff % 3600000) / 60000).toString().padStart(2, '0');
      const seconds = Math.floor((diff % 60000) / 1000).toString().padStart(2, '0');
      uptime.textContent = `${hours}:${minutes}:${seconds}`;
    }

    function normalizeBaseUrl(url) {
      // Remove trailing slash if present
      return url.replace(/\/+$/, '');
    }

    function authHeaders() {
      // OllaBridge accepts Authorization: Bearer <key>
      return {
        'Authorization': `Bearer ${apiKey}`,
        'Content-Type': 'application/json'
      };
    }

    async function fetchJson(url, options = {}) {
      const res = await fetch(url, options);
      let data = null;
      const ct = res.headers.get('content-type') || '';
      if (ct.includes('application/json')) data = await res.json();
      else data = await res.text();

      if (!res.ok) {
        const msg = (data && data.detail) ? data.detail : (typeof data === 'string' ? data : JSON.stringify(data));
        throw new Error(`${res.status} ${res.statusText}: ${msg}`);
      }
      return data;
    }

    async function loadModels() {
      addToConsole('> Loading models from /v1/models ...', 'blue');
      const modelsUrl = `${serverBase}/v1/models`;
      const data = await fetchJson(modelsUrl, { headers: authHeaders() });

      // Expected shape: { object:"list", data:[{id:"...", object:"model"}] }
      const list = Array.isArray(data?.data) ? data.data : [];

      modelSelect.innerHTML = '';
      if (list.length === 0) {
        modelSelect.innerHTML = `<option value="">(no models found)</option>`;
        addToConsole('> No models returned. Is Ollama running and does it have models pulled?', 'yellow');
        return;
      }

      for (const m of list) {
        const opt = document.createElement('option');
        opt.value = m.id;
        opt.textContent = m.id;
        modelSelect.appendChild(opt);
      }

      addToConsole(`> Loaded ${list.length} model(s).`, 'green');
    }

    // Events
    installBtn.addEventListener('click', () => {
      addToConsole('> INSTALL (Mac/Linux):', 'blue');
      addToConsole('  1) pip install ollabridge', 'white');
      addToConsole('  2) ollabridge start', 'white');
      addToConsole('> Then set CORS_ORIGINS=http://localhost:3000 in .env if using this demo.', 'yellow');
    });

    connectBtn.addEventListener('click', async () => {
      const url = serverUrlInput.value.trim();
      const key = apiKeyInput.value.trim();

      if (!url) {
        addToConsole('> Please enter a valid server URL', 'red');
        errorCountValue++; setErrorCount();
        return;
      }
      if (!key) {
        addToConsole('> Please enter an API key (matches API_KEYS in OllaBridge .env)', 'red');
        errorCountValue++; setErrorCount();
        return;
      }

      serverBase = normalizeBaseUrl(url);
      apiKey = key;

      addToConsole(`> Connecting to ${serverBase} ...`, 'blue');

      try {
        // 1) Health (no auth)
        const health = await fetchJson(`${serverBase}/health`);
        addToConsole(`> /health OK: ${JSON.stringify(health)}`, 'green');

        // 2) Auth check via /v1/models (requires API key)
        await loadModels();

        // Mark connected
        updateConnectionStatus(true);
        startTime = new Date();

        if (uptimeTimer) clearInterval(uptimeTimer);
        updateUptime();
        uptimeTimer = setInterval(updateUptime, 1000);

        addToConsole('> Connected âœ…', 'green');
      } catch (err) {
        updateConnectionStatus(false);
        addToConsole(`> Connection failed: ${err.message}`, 'red');
        errorCountValue++; setErrorCount();

        addToConsole('> Common fixes:', 'yellow');
        addToConsole('  - Is OllaBridge running? (ollabridge start)', 'white');
        addToConsole('  - Is this page served from http://localhost:3000 ? (python -m http.server 3000)', 'white');
        addToConsole('  - Does OllaBridge .env include CORS_ORIGINS=http://localhost:3000 ?', 'white');
        addToConsole('  - Is the API key correct?', 'white');
      }
    });

    disconnectBtn.addEventListener('click', () => {
      addToConsole('> Disconnected', 'yellow');
      updateConnectionStatus(false);
      serverBase = "";
      apiKey = "";
      startTime = null;
      if (uptimeTimer) clearInterval(uptimeTimer);
      uptime.textContent = "00:00:00";
      modelSelect.innerHTML = `<option value="">(load models after connect)</option>`;
    });

    clearLogBtn.addEventListener('click', () => {
      consoleLog.innerHTML = '<div class="text-green-400">> Log cleared</div>';
    });

    sendPromptBtn.addEventListener('click', async () => {
      const prompt = testPrompt.value.trim();
      if (!prompt) {
        addToConsole('> Please enter a test prompt', 'red');
        errorCountValue++; setErrorCount();
        return;
      }
      if (!isConnected || !serverBase || !apiKey) {
        addToConsole('> Not connected to OllaBridge', 'red');
        errorCountValue++; setErrorCount();
        return;
      }

      // Choose model: dropdown, fallback blank (server default)
      const selectedModel = modelSelect.value || null;

      addToConsole(`> Sending prompt to /v1/chat/completions ...`, 'blue');
      addToConsole(`  model=${selectedModel || '(default)'}`, 'white');

      const t0 = performance.now();
      requestCount++;
      requestsSent.textContent = requestCount;

      try {
        const body = {
          model: selectedModel,
          messages: [{ role: "user", content: prompt }]
        };

        const data = await fetchJson(`${serverBase}/v1/chat/completions`, {
          method: 'POST',
          headers: authHeaders(),
          body: JSON.stringify(body)
        });

        const latency = Math.round(performance.now() - t0);
        totalLatency += latency;
        const avg = Math.round(totalLatency / requestCount);

        lastResponseTime.textContent = `${latency} ms`;
        avgLatency.textContent = `${avg} ms`;

        // OpenAI-compatible shape: choices[0].message.content
        const text = data?.choices?.[0]?.message?.content ?? JSON.stringify(data, null, 2);

        showResponse(text);
        addToConsole(`> Response received in ${latency}ms`, 'green');
      } catch (err) {
        const latency = Math.round(performance.now() - t0);
        lastResponseTime.textContent = `${latency} ms`;

        addToConsole(`> Request failed: ${err.message}`, 'red');
        errorCountValue++; setErrorCount();
      }
    });

    // Init
    addToConsole('> Welcome to OllaBridge Connect!', 'blue');
    addToConsole('> Serve this page via: python3 -m http.server 3000', 'yellow');
    addToConsole('> Then connect to: http://localhost:11435 (default)', 'green');
  </script>
</body>
</html>
