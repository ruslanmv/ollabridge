name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    name: Test on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest]
        python-version: ["3.10", "3.11"]

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: âš¡ Install uv (ultra-fast package installer)
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: ğŸ“¦ Install OllaBridge
        run: |
          uv pip install --system -e ".[dev]"

      - name: ğŸ§ª Run unit tests
        run: |
          pytest tests/ -v --ignore=tests/integration/

      - name: ğŸ” Code quality checks
        run: |
          ruff check src/ollabridge/
          black --check src/ollabridge/

  integration-test:
    name: Integration Test with Ollama
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: âš¡ Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: ğŸ“¦ Install OllaBridge
        run: |
          uv pip install --system -e ".[dev]"

      - name: ğŸ§  Install Ollama
        run: |
          curl -fsSL https://ollama.com/install.sh | sh

      - name: ğŸš€ Start Ollama service
        run: |
          ollama serve &
          sleep 10
          echo "âœ“ Ollama service started"

      - name: ğŸ“¥ Pull lightweight model (tinyllama)
        run: |
          ollama pull tinyllama
          ollama list
          echo "âœ“ Model ready"

      - name: ğŸ§ª Run integration tests
        env:
          OLLAMA_BASE_URL: "http://localhost:11434"
          DEFAULT_MODEL: "tinyllama"
        run: |
          pytest tests/integration/ -v -s

      - name: ğŸ¯ Quick smoke test (Hello World)
        env:
          OLLAMA_BASE_URL: "http://localhost:11434"
          DEFAULT_MODEL: "tinyllama"
        run: |
          # Start OllaBridge in background
          ollabridge start --model tinyllama &
          OLLABRIDGE_PID=$!

          # Wait for startup
          sleep 10

          # Check health
          curl -f http://localhost:11435/health || exit 1

          # Get API key from .env
          API_KEY=$(grep "API_KEYS=" .env | cut -d'=' -f2 | cut -d',' -f1)

          # Test hello world query
          RESPONSE=$(curl -s -X POST http://localhost:11435/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $API_KEY" \
            -d '{
              "model": "tinyllama",
              "messages": [{"role": "user", "content": "Say hello"}],
              "max_tokens": 50
            }')

          echo "Response: $RESPONSE"

          # Check if response contains content
          if echo "$RESPONSE" | grep -q "content"; then
            echo "âœ“ Hello world test passed!"
          else
            echo "âœ— Hello world test failed!"
            kill $OLLABRIDGE_PID
            exit 1
          fi

          # Cleanup
          kill $OLLABRIDGE_PID

  build:
    name: Build Distribution
    runs-on: ubuntu-latest
    needs: [test, integration-test]

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ğŸ“¦ Install build tools
        run: |
          python -m pip install --upgrade pip build

      - name: ğŸ”¨ Build distribution
        run: |
          python -m build

      - name: ğŸ“¤ Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-packages
          path: dist/

      - name: âœ… Verify build
        run: |
          ls -lh dist/
          echo "âœ“ Build complete"
